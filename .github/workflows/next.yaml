name: Test Next

on:
  workflow_dispatch:      # Knapp för att starta manuellt
  schedule:
    - cron: '0 1 * * *'   # Körs 01:00 UTC varje natt

env:
  COMPONENT: varmegolv_kontroll

jobs:
  # Vi kör alltid validate/lint först. Är koden trasig vill vi veta det innan vi kör tunga tester.
  validate:
    name: Validate & Package
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Hassfest Validation
        uses: home-assistant/actions/hassfest@master
      - name: HACS Validation
        uses: hacs/action@main
        with:
          category: integration
          ignore: brands

  lint:
    name: Lint Code (Ruff)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install Ruff
        run: pip install ruff
      - name: Run Ruff
        run: ruff check .

  # HUVUDNUMRET: Endast Test Next.
  test-next:
    name: Test Next (Dev/Future)
    runs-on: ubuntu-latest
    needs: [validate, lint]
    # OBS: Ingen continue-on-error här. Vi VILL att den ska bli RÖD om den failar på natten.
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python (Latest)
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies (Dev/Nightly)
        run: |
          sudo apt-get update
          sudo apt-get install -y libpcap-dev
          
          pip install pytest pytest-homeassistant-custom-component
          if [ -f requirements_test.txt ]; then pip install -r requirements_test.txt; fi
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          
          # Tvinga installation av HA Dev
          echo "⚠️ Installing Home Assistant Dev/Nightly..."
          pip install git+https://github.com/home-assistant/core.git@dev --upgrade --force-reinstall

      - name: Run Tests
        run: |
          # 1. Kolla om mappen 'tests' finns i roten (standard)
          if [ -d "tests" ]; then
            echo "✅ Hittade tester i roten. Kör..."
            pytest tests
            exit 0
          fi

          # 2. Kolla om mappen finns inuti komponenten (HACS-struktur)
          if [ -d "custom_components/${{ env.COMPONENT }}/tests" ]; then
            echo "✅ Hittade tester i komponenten. Kör..."
            pytest "custom_components/${{ env.COMPONENT }}/tests"
            exit 0
          fi

          # 3. Om inget hittas: Var glad ändå!
          echo "⚠️ Inga tester hittades. Hoppar över test-steget."
          exit 0
